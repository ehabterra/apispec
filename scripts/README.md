# APISpec Metrics Visualization Tools

This directory contains tools to visualize and analyze the performance metrics generated by APISpec.

## Files

- `metrics_viewer.html` - Interactive HTML-based charts using Chart.js
- `view_metrics.sh` - Interactive shell script to choose visualization method

## Quick Start

### 1. Generate Metrics

First, run APISpec with metrics collection enabled:

```bash
# Basic metrics collection
./apispec --dir ./myproject --output spec.yaml --custom-metrics

# With all profiling enabled
./apispec --dir ./myproject --output spec.yaml --custom-metrics --cpu-profile --mem-profile
```

This will create a `profiles/metrics.json` file.

### 2. View Metrics

#### Option A: Interactive Shell Script (Recommended)

```bash
./scripts/view_metrics.sh
```

This will present you with options:

1. HTML Viewer (opens in browser)
2. Quick Summary (text only)
3. JSON Pretty Print
4. Raw JSON
5. Choose different metrics file

#### Option B: Direct Usage

**HTML Viewer:**

```bash
# Open in browser (will try to load default metrics.json)
open scripts/metrics_viewer.html

# Or serve locally (if you have Python3)
python3 -m http.server 8000
# Then open http://localhost:8000/scripts/metrics_viewer.html

# Load specific metrics file directly via URL parameter
# http://localhost:8000/scripts/metrics_viewer.html?file=profiles/chi-metrics.json
# http://localhost:8000/scripts/metrics_viewer.html?file=profiles/fiber-metrics.json
```

**Quick Summary:**

```bash
# Using jq for detailed summary
jq -r '.[] | select(.name == "memory.alloc") | .value' profiles/metrics.json | sort -n | tail -1

# Using the interactive script
./scripts/view_metrics.sh
```

## Metrics Explained

### Memory Metrics

- **memory.alloc**: Current memory allocation (MB)
- **memory.total_alloc**: Total memory allocated over time (GB)
- **memory.mallocs**: Number of memory allocations
- **memory.frees**: Number of memory deallocations

### Garbage Collection

- **gc.num_gc**: Number of garbage collections
- **gc.pause_total**: Total time spent in GC pauses (ms)
- **gc.pause_avg**: Average GC pause time (μs)

### Performance

- **openapi_generation**: Total time for OpenAPI generation (seconds)
- **generation.success**: Whether generation succeeded (1/0)

### Concurrency

- **goroutines.count**: Number of active goroutines

## Direct File Loading

The HTML viewer supports loading specific metrics files directly via URL parameters:

### URL Parameter Format

```url
http://localhost:8000/scripts/metrics_viewer.html?file=path/to/metrics.json
```

### Examples

```bash
# Load specific metrics file
http://localhost:8000/scripts/metrics_viewer.html?file=profiles/chi-metrics.json
http://localhost:8000/scripts/metrics_viewer.html?file=profiles/fiber-metrics.json
http://localhost:8000/scripts/metrics_viewer.html?file=profiles/gitea-metrics.json

# Relative paths work from the project root
http://localhost:8000/scripts/metrics_viewer.html?file=profiles/metrics.json
```

### Benefits

- **Direct access**: Skip the file browser and load metrics immediately
- **Bookmarkable**: Save URLs for specific metrics files
- **Automation**: Use in scripts or CI/CD pipelines
- **Comparison**: Open multiple tabs with different metrics files

### Fallback Behavior

- If no `file` parameter is provided, tries to load `profiles/metrics.json`
- If the specified file doesn't exist, shows an error message
- File browser functionality remains available for manual selection

## Understanding the Charts

### Memory Usage Chart

Shows how memory consumption changes over time. Look for:

- **Memory leaks**: Continuously increasing memory
- **Memory spikes**: Sudden increases that don't decrease
- **Efficient usage**: Stable memory with occasional GC cleanup

### GC Activity Chart

Shows garbage collection frequency and pause times. Look for:

- **High frequency**: Many GCs indicate high allocation rate
- **Long pauses**: High pause times can cause performance issues
- **Efficient GC**: Low frequency with short pauses

### Allocation Chart

Shows total memory allocated over time. Look for:

- **Allocation rate**: How fast memory is being allocated
- **Total usage**: Final total allocations
- **Growth pattern**: Linear vs exponential growth

### Goroutines Chart

Shows concurrent goroutine usage. Look for:

- **Goroutine leaks**: Continuously increasing count
- **Efficient concurrency**: Appropriate number for workload
- **Cleanup**: Proper goroutine termination

## Performance Analysis Tips

### Good Performance Indicators

- ✅ Stable memory usage with periodic GC cleanup
- ✅ Low GC frequency (< 10 per second)
- ✅ Short GC pauses (< 1ms average)
- ✅ Reasonable total allocations for project size
- ✅ Proper goroutine cleanup

### Performance Issues to Watch

- ⚠️ Continuously increasing memory (potential leak)
- ⚠️ High GC frequency (> 20 per second)
- ⚠️ Long GC pauses (> 5ms average)
- ⚠️ Excessive total allocations
- ⚠️ Goroutine count not decreasing

### Optimization Strategies

1. **Reduce allocations**: Pre-allocate slices/maps with known capacity
2. **Object pooling**: Reuse objects instead of creating new ones
3. **String optimization**: Use string builders for concatenation
4. **Memory profiling**: Use `--mem-profile` to identify allocation hotspots
5. **CPU profiling**: Use `--cpu-profile` to find performance bottlenecks

## Generate and Display Metrics

```bash
./apispec --dir testdata/chi --output chi-spec.yaml --custom-metrics
make metrics-view
```

### Performance Comparison

```bash
# Run with different configurations and compare metrics
./apispec --dir ./project --output spec1.yaml --custom-metrics --max-nodes 10000
./apispec --dir ./project --output spec2.yaml --custom-metrics --max-nodes 50000
# Compare the generated metrics.json files
```

## Troubleshooting

### HTML Viewer Not Loading

- Ensure you're serving from a web server (not file://)
- Check browser console for JavaScript errors
- Verify metrics.json is valid JSON

### No Metrics Generated

- Ensure `--custom-metrics` flag is used
- Check that profiles directory exists and is writable
- Verify the run completed successfully

## Contributing

To add new visualization features:

1. Add new chart types to `metrics_viewer.html`
2. Extend `view_metrics.sh` with new options
3. Update the HTML viewer with new chart types
